{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block additional_styles %}
<style>
    .dashboard-stats {
        margin-bottom: 30px;
    }
    .stat-card {
        border-radius: 10px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        min-height: 120px;
    }
    
    /* Default colors for stat cards */
    #positive-filter {
        background-color: #28a745;
    }
    
    #negative-filter {
        background-color: #ffc107;
    }
    
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .stat-card .stat-icon {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 3rem;
        opacity: 0.2;
    }
    .message-card {
        transition: all 0.3s;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .message-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .message-card .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .message-card .card-title {
        margin-bottom: 12px;
    }
    .message-card p {
        margin-bottom: 8px;
    }
    .standardized-text {
        flex-grow: 1;
    }
    body[data-theme="dark"] {
        --primary-color: #2A9D8F;
        --secondary-color: #264653;
        --accent-color: #E9C46A;
        --light-color: #23272f;
        --dark-color: #f4f1de;
        --card-background-color: #23272f;
        --text-color: #f4f1de;
        --text-color-secondary: #adb5bd;
        background-color: var(--light-color);
        color: var(--dark-color);
    }
    .theme-toggle-btn {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1050;
        background: var(--primary-color);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: background 0.3s;
    }
    .theme-toggle-btn:hover {
        background: var(--secondary-color);
    }
    
    .avatar-edit-btn {
        transition: opacity 0.2s ease;
    }
    
    .avatar-edit-btn:hover {
        opacity: 1 !important;
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Dashboard</h1>

<div class="row dashboard-stats">
    <div class="col-md-4">
        <div class="card stat-card bg-primary text-white d-flex flex-row align-items-center position-relative">
            <img src="/static/avatars/avatar1.svg" alt="Avatar" class="rounded-circle me-3" style="width:64px;height:64px;object-fit:cover;" id="current-avatar">
            <div class="d-flex flex-column justify-content-center" style="margin-left: 8px;">
                <h5 class="card-title mb-1">Welcome</h5>
                <p class="card-text mb-0">{{ username }}</p>
            </div>
            <button type="button" class="btn btn-sm btn-light position-absolute avatar-edit-btn" style="top: 8px; right: 8px; padding: 4px 8px; font-size: 12px; opacity: 0.8;" data-bs-toggle="modal" data-bs-target="#avatarSelectionModal" title="Change Avatar">
                <i class="fas fa-edit" style="font-size: 10px;"></i>
            </button>
        </div>
    </div>
    <div class="col-md-4">
        <div id="positive-filter" class="card stat-card text-white d-flex flex-column justify-content-center" style="cursor: pointer;" title="Click to filter positive messages" data-category="positive">
            <div class="stat-icon">
                <i class="fas fa-thumbs-up"></i>
            </div>
            <div class="text-center">
                <h5 class="card-title mb-1">Positive Messages</h5>
                <p class="card-text mb-0">{{ positive_messages|length }}</p>
            </div>
            {% if active_filter == 'positive' %}
            <span class="badge bg-light text-success position-absolute bottom-0 end-0 m-2">Filtered</span>
            {% endif %}
        </div>
    </div>
    <div class="col-md-4">
        <div id="negative-filter" class="card stat-card text-white d-flex flex-column justify-content-center" style="cursor: pointer;" title="Click to filter negative messages" data-category="negative">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="text-center">
                <h5 class="card-title mb-1">Negative Messages</h5>
                <p class="card-text mb-0">{{ negative_messages|length }}</p>
            </div>
            {% if active_filter == 'negative' %}
            <span class="badge bg-light text-warning position-absolute bottom-0 end-0 m-2">Filtered</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h5 class="card-title">Pastoral Message</h5>
        <form id="message-form" method="POST" action="{{ url_for('create_message') }}">
            <div class="mb-3">
                <label for="message-name" class="form-label">Message</label>
                <textarea class="form-control" id="message-name" name="name" rows="3" required></textarea>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" id="category" name="category" required>
                        <option value="" disabled selected>Select a category</option>
                        <option value="positive">Positive</option>
                        <option value="negative">Negative</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="subcategory" class="form-label">Subcategory</label>
                    <select class="form-select" id="subcategory" name="subcategory" required>
                        <option value="" disabled selected>Select a subcategory</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-3" id="standardized-message-container" style="display: none;">
                <label for="standardized-message" class="form-label">Standardised Message</label>
                <textarea class="form-control" id="standardized-message" name="standardized_message" rows="4" readonly></textarea>
                <div id="standardized-message-status" class="form-text"></div>
            </div>
            
            <div class="d-flex justify-content-between">
                <button type="button" id="standardize-btn" class="btn btn-secondary">Standardise Message</button>
                <button type="submit" id="post-message-btn" class="btn btn-primary" disabled>Post Message</button>
            </div>
        </form>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Your Pastoral Messages</h3>
    <div class="d-flex gap-2 align-items-center flex-wrap">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#colorCustomizationModal">
            <i class="fas fa-palette me-1"></i>Customize Colors
        </button>
        <select id="message-filter" class="form-select form-select-sm" style="width: auto;">
            <option value="all" {% if not active_filter %}selected{% endif %}>Recent First (Default)</option>
            <option value="positive" {% if active_filter == 'positive' %}selected{% endif %}>Positive Only</option>
            <option value="negative" {% if active_filter == 'negative' %}selected{% endif %}>Negative Only</option>
            <option value="oldest" {% if active_filter == 'oldest' %}selected{% endif %}>Oldest First</option>
            <option value="date" {% if active_filter == 'date' %}selected{% endif %}>Filter by Date</option>
        </select>
        <div id="date-filter-container" style="display: none;">
            <input type="date" id="date-filter" class="form-control form-control-sm" style="width: auto;" value="{{ request.args.get('date', '') }}">
            <button type="button" id="calendar-btn" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#calendarModal">
                <i class="fas fa-calendar-alt"></i>
            </button>
        </div>
        {% if active_filter %}
        <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-times"></i> Clear
        </a>
        {% endif %}
    </div>
</div>

{% if messages %}
<div class="row" id="messages-container">
    {% for message in messages %}
    <div class="col-md-4 mb-4 message-item" data-index="{{ loop.index0 }}" {% if loop.index0 >= 3 %}style="display: none;"{% endif %}>
        <div class="card message-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="category-banner" data-category="{{ message.severity }}" style="color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">
                        <h5 class="card-title mb-0">{{ message.subcategory }}</h5>
                    </div>
                </div>
                <p class="text-muted small">{{ message.created_at|aest_time }}</p>
                <p><strong>Original:</strong> {{ message.name }}</p>
                <p class="standardized-text"><strong>Standardised:</strong> {{ message.standardized_message }}</p>
                <div class="mt-auto pt-2 text-end">
                    <button type="button" class="btn btn-sm btn-outline-primary copy-btn me-2" data-message="{{ message.standardized_message }}" title="Copy standardised message">
                        <i class="fas fa-copy"></i>
                    </button>
                    <form action="{{ url_for('delete_message', message_id=message.id) }}" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-danger delete-btn" data-title="'{{ message.subcategory }}'">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if messages|length > 3 %}
<div class="text-center mb-4">
    <button id="expand-messages-btn" class="btn btn-outline-primary">
        <i class="fas fa-chevron-down me-2"></i>Show More Messages ({{ messages|length - 3 }} remaining)
    </button>
    <button id="collapse-messages-btn" class="btn btn-outline-secondary" style="display: none;">
        <i class="fas fa-chevron-up me-2"></i>Show Less
    </button>
</div>
{% endif %}
{% else %}
<div class="alert alert-info">
    <p>You haven't created any messages yet. Use the form above to create your first message.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Typing timer variables
        var typingTimer;
        var doneTypingInterval = 1000;
        
        // Add click handlers for message filtering
        $('#positive-filter').click(function() {
            window.location.href = "{{ url_for('dashboard') }}?filter=positive";
        });
        
        $('#negative-filter').click(function() {
            window.location.href = "{{ url_for('dashboard') }}?filter=negative";
        });
        
        // Handle category change to update subcategory options
        $('#category').change(function() {
            var category = $(this).val();
            var $subcategory = $('#subcategory');
            $subcategory.empty();
            
            if (category === 'positive') {
                $subcategory.append('<option value="" disabled selected>Select a subcategory</option>');
                $subcategory.append('<option value="Affirmation">Affirmation</option>');
                $subcategory.append('<option value="Merit / Record of Achievement">Merit / Record of Achievement</option>');
            } else if (category === 'negative') {
                $subcategory.append('<option value="" disabled selected>Select a subcategory</option>');
                $subcategory.append('<option value="Informal Conversation">Informal Conversation</option>');
                $subcategory.append('<option value="Challenge">Challenge</option>');
                $subcategory.append('<option value="White Card">White Card</option>');
                $subcategory.append('<option value="Friday Detention">Friday Detention</option>');
            } else {
                $subcategory.append('<option value="" disabled selected>Select a subcategory</option>');
            }
        });
        
        // Add validation to ensure category is selected before form submission
        $('#message-form').on('submit', function(e) {
            if (!$('#category').val()) {
                e.preventDefault();
                alert('Please select a category');
                return false;
            }
            if (!$('#subcategory').val()) {
                e.preventDefault();
                alert('Please select a subcategory');
                return false;
            }
        });
        
        // Function to standardise message
        function standardizeMessage() {
            // Client-side validation before making the request
            var messageText = $("#message-name").val().trim();
            if (!messageText) {
                $("#standardized-message-status").html(
                    '<div class="alert alert-info alert-dismissible fade show p-2 mt-2" role="alert">' +
                    '<i class="fas fa-info-circle me-2"></i>' +
                    '<strong>Required Field:</strong> Please fill in all required fields. A message is needed before standardisation can begin.' +
                    '<button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert" aria-label="Close"></button>' +
                    '</div>'
                );
                // Keep submit button disabled
                $("#post-message-btn").prop('disabled', true);
                // Focus on the message field
                $("#message-name").focus();
                return;
            }
            
            $("#standardized-message-status").html("Generating standardised message...");
            // Disable submit button while generating
            $("#post-message-btn").prop('disabled', true);
            
            $.ajax({
                url: "/standardize_message",
                type: "POST",
                data: {
                    name: messageText,
                    category: $("#category").val(),
                    subcategory: $("#subcategory").val()
                },
                dataType: "json"
            })
            .done(function(data) {
                $("#standardized-message").val(data.standardized_message);
                $("#standardized-message-status").html('<div class="text-success"><i class="fas fa-check-circle me-1"></i>Message standardised successfully!</div>');
                // Enable submit button after successful standardisation
                $("#post-message-btn").prop('disabled', false);
            })
            .fail(function(jqXHR) {
                var errorMsg = "Connection error occurred. Please check your internet connection and try again.";
                if (jqXHR.responseJSON && jqXHR.responseJSON.error) {
                    errorMsg = jqXHR.responseJSON.error;
                }
                
                // Show error message with retry button
                $("#standardized-message-status").html(
                    '<div class="alert alert-warning alert-dismissible fade show p-2 mt-2" role="alert">' +
                    '<i class="fas fa-exclamation-triangle me-2"></i>' +
                    '<strong>Standardisation Error:</strong> ' + errorMsg + 
                    '<div class="mt-2">' +
                    '<button type="button" class="btn btn-sm btn-outline-primary me-2" id="retry-standardize">' +
                    '<i class="fas fa-redo me-1"></i>Retry Standardisation' +
                    '</button>' +
                    '<button type="button" class="btn btn-sm btn-outline-secondary" id="continue-without-standardize">' +
                    '<i class="fas fa-forward me-1"></i>Continue Without Standardisation' +
                    '</button>' +
                    '</div>' +
                    '<button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert" aria-label="Close"></button>' +
                    '</div>'
                );
                
                // Keep submit button disabled on error
                $("#post-message-btn").prop('disabled', true);
            });
        }
        
        // Handle retry standardisation button
        $(document).on('click', '#retry-standardize', function() {
            // Clear the error message
            $("#standardized-message-status").html("");
            // Retry the standardisation
            standardizeMessage();
        });
        
        // Handle continue without standardisation button
        $(document).on('click', '#continue-without-standardize', function() {
            // Clear the error message
            $("#standardized-message-status").html('<div class="text-info"><i class="fas fa-info-circle me-1"></i>Proceeding without AI standardisation.</div>');
            // Copy original message to standardised field
            $("#standardized-message").val($("#message-name").val());
            // Enable submit button
            $("#post-message-btn").prop('disabled', false);
        });
        
        // Handle input changes with debounce
        $('#message-name, #category, #subcategory').on('input change', function() {
            clearTimeout(typingTimer);
            
            // Disable submit button when inputs change
            $("#post-message-btn").prop('disabled', true);
            
            const messageText = $('#message-name').val().trim();
            const category = $('#category').val();
            const subcategory = $('#subcategory').val();
            
            if (messageText.length > 3 && category && subcategory) {
                $('#standardized-message-status').html('Generating standardised message...');
                $('#standardized-message-container').show();
                
                typingTimer = setTimeout(function() {
                    standardizeMessage();
                }, doneTypingInterval);
            } else {
                $('#standardized-message-container').hide();
            }
        });
        
        // Manual standardize button
        $("#standardize-btn").click(function(e) {
            e.preventDefault();
            
            // Disable submit button when standardizing manually
            $("#post-message-btn").prop('disabled', true);
            
            const messageText = $('#message-name').val().trim();
            const category = $('#category').val();
            const subcategory = $('#subcategory').val();
            
            if (messageText.length > 0 && category && subcategory) {
                $('#standardized-message-container').show();
                standardizeMessage();
            } else {
                // Show nice validation message instead of alert
                $("#standardized-message-status").html(
                    '<div class="alert alert-info alert-dismissible fade show p-2 mt-2" role="alert">' +
                    '<i class="fas fa-info-circle me-2"></i>' +
                    '<strong>Required Fields:</strong> Please fill in all required fields before standardisation can begin.' +
                    '<button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert" aria-label="Close"></button>' +
                    '</div>'
                );
                $('#standardized-message-container').show();
                // Focus on the first empty field
                if (!messageText) {
                    $("#message-name").focus();
                } else if (!category) {
                    $("#category").focus();
                } else if (!subcategory) {
                    $("#subcategory").focus();
                }
            }
        });
        
    // Custom delete confirmation modal logic
    let messageToDelete = null;
    $(document).on('click', '.delete-btn', function(e) {
        e.preventDefault();
        messageToDelete = $(this).closest('form');
        const messageTitle = $(this).data('title') || 'this message';
        $('#deleteModalMessage').text(`Are you sure you want to delete ${messageTitle}? This action cannot be undone.`);
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    });
    $('#confirmDeleteBtn').click(function() {
        if (messageToDelete) {
            messageToDelete.submit();
        }
    });

    // Expand/Collapse messages functionality
    $('#expand-messages-btn').click(function() {
        $('.message-item[data-index]').show();
        $(this).hide();
        $('#collapse-messages-btn').show();
    });

    $('#collapse-messages-btn').click(function() {
        $('.message-item[data-index]').each(function() {
            if (parseInt($(this).data('index')) >= 3) {
                $(this).hide();
            }
        });
        $(this).hide();
        $('#expand-messages-btn').show();
    });

    // Avatar selection functionality
    $('.avatar-choice').click(function() {
        // Remove selection from all avatars
        $('.avatar-choice').css('border', '3px solid transparent');
        
        // Add selection to clicked avatar
        $(this).css('border', '3px solid #007bff');
        
        // Update the main avatar
        const selectedAvatar = $(this).data('avatar');
        $('#current-avatar').attr('src', '/static/avatars/' + selectedAvatar);
        
        // Save selection
        localStorage.setItem(`selected-avatar-${username}`, selectedAvatar);
        
        // Hide Apply Changes button when selecting regular avatars
        $('#applyAvatarChanges').hide();
        selectedCustomColor = null;
        
        // Close modal after a short delay for visual feedback
        setTimeout(function() {
            $('#avatarSelectionModal').modal('hide');
        }, 500);
    });

    // Load saved avatar on page load and highlight selected option
    const username = "{{ username }}";
    const savedAvatar = localStorage.getItem(`selected-avatar-${username}`);
    if (savedAvatar) {
        $('#current-avatar').attr('src', '/static/avatars/' + savedAvatar);
        // Highlight the selected avatar in modal
        $(`.avatar-choice[data-avatar="${savedAvatar}"]`).css('border', '3px solid #007bff');
    } else {
        // Default to first avatar if none selected
        $('#avatar-choice-1').css('border', '3px solid #007bff');
    }

    // Custom avatar color picker functionality
    let selectedCustomColor = null;
    
    $('#custom-avatar-choice').click(function() {
        // Set current color if previously selected
        const currentCustomColor = localStorage.getItem(`custom-avatar-color-${username}`) || '#007bff';
        $('#customAvatarColorPicker').val(currentCustomColor);
        selectedCustomColor = currentCustomColor;
        
        // Show the Apply Changes button
        $('#applyAvatarChanges').show();
        
        // Immediately open the color picker
        $('#customAvatarColorPicker').click();
    });

    $('#customAvatarColorPicker').change(function() {
        selectedCustomColor = $(this).val();
        // Don't apply immediately, wait for Apply Changes button
    });

    // Apply Changes button functionality
    $('#applyAvatarChanges').click(function() {
        if (selectedCustomColor) {
            // Remove selection from all avatars
            $('.avatar-choice').css('border', '3px solid transparent');
            
            // Add selection to custom avatar option
            $('#custom-avatar-choice').css('border', '3px solid #007bff');
            
            // Create a custom avatar with the selected color (using same design as preset avatars)
            const customAvatarSvg = `<svg width="64" height="64" xmlns="http://www.w3.org/2000/svg">
                <circle cx="32" cy="32" r="32" fill="${selectedCustomColor}"/>
                <circle cx="32" cy="24" r="8" fill="white"/>
                <circle cx="32" cy="48" r="12" fill="white"/>
            </svg>`;
            
            // Convert SVG to data URL and update avatar
            const dataUrl = 'data:image/svg+xml;base64,' + btoa(customAvatarSvg);
            $('#current-avatar').attr('src', dataUrl);
            
            // Save custom color selection
            localStorage.setItem(`selected-avatar-${username}`, 'custom');
            localStorage.setItem(`custom-avatar-color-${username}`, selectedCustomColor);
            
            // Hide the Apply Changes button
            $('#applyAvatarChanges').hide();
            selectedCustomColor = null;
            
            // Close modal after a short delay for visual feedback
            setTimeout(function() {
                $('#avatarSelectionModal').modal('hide');
            }, 500);
        }
    });

    // Hide Apply Changes button when modal is closed or other avatars are selected
    $('#avatarSelectionModal').on('hidden.bs.modal', function() {
        $('#applyAvatarChanges').hide();
        selectedCustomColor = null;
    });

    // Load custom avatar if previously selected
    if (savedAvatar === 'custom') {
        const customColor = localStorage.getItem(`custom-avatar-color-${username}`) || '#007bff';
        const customAvatarSvg = `<svg width="64" height="64" xmlns="http://www.w3.org/2000/svg">
            <circle cx="32" cy="32" r="32" fill="${customColor}"/>
            <circle cx="32" cy="24" r="8" fill="white"/>
            <circle cx="32" cy="48" r="12" fill="white"/>
        </svg>`;
        const dataUrl = 'data:image/svg+xml;base64,' + btoa(customAvatarSvg);
        $('#current-avatar').attr('src', dataUrl);
        $('#custom-avatar-choice').css('border', '3px solid #007bff');
    }

    // Copy message functionality
    $('.copy-btn').click(function() {
        const messageText = $(this).data('message');
        const button = $(this);
        const originalIcon = button.find('i').attr('class');
        
        // Copy to clipboard
        navigator.clipboard.writeText(messageText).then(function() {
            // Show success feedback
            button.find('i').attr('class', 'fas fa-check');
            button.removeClass('btn-outline-primary').addClass('btn-success');
            
            // Reset after 2 seconds
            setTimeout(function() {
                button.find('i').attr('class', originalIcon);
                button.removeClass('btn-success').addClass('btn-outline-primary');
            }, 2000);
        }).catch(function(err) {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = messageText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // Show success feedback
            button.find('i').attr('class', 'fas fa-check');
            button.removeClass('btn-outline-primary').addClass('btn-success');
            
            // Reset after 2 seconds
            setTimeout(function() {
                button.find('i').attr('class', originalIcon);
                button.removeClass('btn-success').addClass('btn-outline-primary');
            }, 2000);
        });
    });

    // Store previous filter for restoration if calendar is cancelled
    let previousFilter = $('#message-filter').val();
    
    // Filter messages functionality
    $('#message-filter').change(function() {
        const filter = $(this).val();
        if (filter === 'date') {
            // Show calendar modal instead of date input
            $('#calendarModal').modal('show');
        } else {
            // Update previous filter for valid selections
            previousFilter = filter;
            $('#date-filter-container').hide();
            if (filter === 'all') {
                window.location.href = "{{ url_for('dashboard') }}";
            } else {
                window.location.href = "{{ url_for('dashboard') }}?filter=" + filter;
            }
        }
    });

    // Date filter functionality
    $('#date-filter').change(function() {
        const selectedDate = $(this).val();
        if (selectedDate) {
            window.location.href = "{{ url_for('dashboard') }}?filter=date&date=" + selectedDate;
        }
    });

    // Show date filter if already selected
    if ($('#message-filter').val() === 'date') {
        $('#date-filter-container').show();
        // If date filter is active, set previous filter to the actual active state
        previousFilter = '{{ active_filter if active_filter != "date" else "all" }}' || 'all';
    } else {
        // Initialize previous filter to current selection
        previousFilter = $('#message-filter').val();
    }

    // Load message dates for calendar highlighting
    let messageDates = [];
    let currentCalendarDate = new Date();
    
    $.get('{{ url_for("get_message_dates") }}', function(dates) {
        messageDates = dates;
        console.log('Message dates received:', dates); // Debug log
        generateCalendar();
    });

    function generateCalendar() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        
        $('#current-month-year').text(new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }));
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        let calendarHTML = '';
        
        // Add day headers
        const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayHeaders.forEach(day => {
            calendarHTML += `<div class="calendar-header">${day}</div>`;
        });
        
        // Generate calendar days
        for (let i = 0; i < 42; i++) {
            const currentDay = new Date(startDate);
            currentDay.setDate(startDate.getDate() + i);
            
            // Format date as YYYY-MM-DD without timezone conversion
            const year = currentDay.getFullYear();
            const month = String(currentDay.getMonth() + 1).padStart(2, '0');
            const day = String(currentDay.getDate()).padStart(2, '0');
            const dayString = `${year}-${month}-${day}`;
            
            const isCurrentMonth = currentDay.getMonth() === currentCalendarDate.getMonth();
            const hasMessages = messageDates.includes(dayString);
            
            // Debug logging for days with messages
            if (hasMessages) {
                console.log(`Day ${dayString} has messages`);
            }
            
            let dayClass = 'calendar-day';
            if (!isCurrentMonth) dayClass += ' other-month';
            if (hasMessages) dayClass += ' has-messages';
            
            calendarHTML += `<div class="${dayClass}" data-date="${dayString}">${currentDay.getDate()}</div>`;
        }
        
        $('#calendar-grid').html(calendarHTML);
    }
    
    // Custom color picker functionality
    $('#custom-color-positive').click(function() {
        $('#color-picker-positive').click();
    });
    
    $('#custom-color-negative').click(function() {
        $('#color-picker-negative').click();
    });
    
    // Handle color picker changes
    $('#color-picker-positive, #color-picker-negative').change(function() {
        const category = $(this).data('category');
        const color = $(this).val();
        
        // Remove selected from preset colors
        $(`.color-btn[data-category="${category}"]`).removeClass('selected');
        
        // Update preview
        $(`.preview-banner[data-category="${category}"]`).css('background-color', color);
        selectedColors[category] = color;
    });

    // Color customization functionality
    // Migrate existing colors to user-specific format (one-time migration for original user only)
    function migrateExistingColors() {
        // Only migrate if this is likely the original user who set the colors
        // We do this by checking if ANY user-specific colors exist in localStorage yet
        const hasAnyUserSpecificColors = Object.keys(localStorage).some(key => 
            key.includes('-color-') || key.includes('-avatar-')
        );
        
        // If no user-specific colors exist anywhere, this might be the original user
        if (!hasAnyUserSpecificColors) {
            const oldPositiveColor = localStorage.getItem('positive-color');
            const oldNegativeColor = localStorage.getItem('negative-color');
            const oldAvatar = localStorage.getItem('selected-avatar');
            const oldCustomColor = localStorage.getItem('custom-avatar-color');
            
            // Only migrate if there were actual customizations (not default values)
            if (oldPositiveColor && oldPositiveColor !== '#28a745') {
                localStorage.setItem(`positive-color-${username}`, oldPositiveColor);
            }
            if (oldNegativeColor && oldNegativeColor !== '#dc3545' && oldNegativeColor !== '#ffc107') {
                localStorage.setItem(`negative-color-${username}`, oldNegativeColor);
            }
            if (oldAvatar) {
                localStorage.setItem(`selected-avatar-${username}`, oldAvatar);
            }
            if (oldCustomColor) {
                localStorage.setItem(`custom-avatar-color-${username}`, oldCustomColor);
            }
            
            // Clean up old global keys to prevent future migrations
            localStorage.removeItem('positive-color');
            localStorage.removeItem('negative-color');
            localStorage.removeItem('selected-avatar');
            localStorage.removeItem('custom-avatar-color');
        }
    }
    
    // Run migration
    migrateExistingColors();
    
    let selectedColors = {
        positive: localStorage.getItem(`positive-color-${username}`) || '#28a745',
        negative: localStorage.getItem(`negative-color-${username}`) || '#dc3545'
    };

    // Apply saved colors on page load
    applyBannerColors();

    function applyBannerColors() {
        $('.category-banner[data-category="positive"]').css('background-color', selectedColors.positive);
        $('.category-banner[data-category="negative"]').css('background-color', selectedColors.negative);
        $('.preview-banner[data-category="positive"]').css('background-color', selectedColors.positive);
        $('.preview-banner[data-category="negative"]').css('background-color', selectedColors.negative);
        
        // Apply colors to stat cards
        $('#positive-filter').css('background-color', selectedColors.positive);
        $('#negative-filter').css('background-color', selectedColors.negative);
        
        // Update selected state in modal
        $('.color-btn').removeClass('selected');
        $(`.color-btn[data-category="positive"][data-color="${selectedColors.positive}"]`).addClass('selected');
        $(`.color-btn[data-category="negative"][data-color="${selectedColors.negative}"]`).addClass('selected');
    }

    // Color selection
    $('.color-btn').click(function() {
        const category = $(this).data('category');
        const color = $(this).data('color');
        
        // Remove selected from same category
        $(`.color-btn[data-category="${category}"]`).removeClass('selected');
        $(this).addClass('selected');
        
        // Update preview
        $(`.preview-banner[data-category="${category}"]`).css('background-color', color);
        selectedColors[category] = color;
    });

    // Apply color changes
    $('#apply-colors').click(function() {
        localStorage.setItem(`positive-color-${username}`, selectedColors.positive);
        localStorage.setItem(`negative-color-${username}`, selectedColors.negative);
        applyBannerColors();
        $('#colorCustomizationModal').modal('hide');
    });

    // Initialize modal with current colors when opened
    $('#colorCustomizationModal').on('show.bs.modal', function() {
        applyBannerColors();
    });

    // Calendar navigation
    $('#prev-month').click(function() {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        generateCalendar();
    });
    
    $('#next-month').click(function() {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        generateCalendar();
    });
    
    // Calendar day click
    $(document).on('click', '.calendar-day', function() {
        const selectedDate = $(this).data('date');
        $('#date-filter').val(selectedDate);
        $('#calendarModal').modal('hide');
        window.location.href = "{{ url_for('dashboard') }}?filter=date&date=" + selectedDate;
    });

    // Handle calendar modal close without selection
    $('#calendarModal').on('hidden.bs.modal', function() {
        // If no date was selected and we came from the filter dropdown, reset it
        const currentFilter = $('#message-filter').val();
        if (currentFilter === 'date' && !window.location.search.includes('filter=date')) {
            // Reset to previous filter value
            $('#message-filter').val(previousFilter);
        }
    });

    function updateCalendar() {
        // This function is called after loading message dates
        if (messageDates.length > 0) {
            const minDate = Math.min(...messageDates.map(d => new Date(d)));
            const maxDate = Math.max(...messageDates.map(d => new Date(d)));
            $('#date-filter').attr('min', new Date(minDate).toISOString().split('T')[0]);
            $('#date-filter').attr('max', new Date(maxDate).toISOString().split('T')[0]);
        }
    }
    });
    
    // Dark mode toggle
    document.addEventListener('DOMContentLoaded', function() {
        const themeBtn = document.getElementById('theme-toggle-btn');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && prefersDark)) {
            document.body.setAttribute('data-theme', 'dark');
        }
        themeBtn.addEventListener('click', function() {
            if (document.body.getAttribute('data-theme') === 'dark') {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        });
    });
</script>

<!-- Color Customization Modal -->
<div class="modal fade" id="colorCustomizationModal" tabindex="-1" aria-labelledby="colorCustomizationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="colorCustomizationModalLabel"><i class="fas fa-palette me-2"></i>Customize Banner Colors</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Positive Messages</h6>
            <div class="color-options mb-3">
              <button type="button" class="btn color-btn" style="background-color: #28a745;" data-category="positive" data-color="#28a745">Green</button>
              <button type="button" class="btn color-btn" style="background-color: #007bff;" data-category="positive" data-color="#007bff">Blue</button>
              <button type="button" class="btn color-btn" style="background-color: #17a2b8;" data-category="positive" data-color="#17a2b8">Teal</button>
              <button type="button" class="btn color-btn" style="background-color: #6f42c1;" data-category="positive" data-color="#6f42c1">Purple</button>
              <button type="button" class="btn color-btn" style="background-color: #20c997;" data-category="positive" data-color="#20c997">Mint</button>
              <button type="button" class="btn color-btn" style="background-color: #6610f2;" data-category="positive" data-color="#6610f2">Indigo</button>
            </div>
            <div class="text-center">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="custom-color-positive">
                <i class="fas fa-palette me-1"></i>More Colors
              </button>
              <input type="color" id="color-picker-positive" style="display: none;" data-category="positive">
            </div>
          </div>
          <div class="col-md-6">
            <h6>Negative Messages</h6>
            <div class="color-options mb-3">
              <button type="button" class="btn color-btn" style="background-color: #ffc107;" data-category="negative" data-color="#ffc107">Yellow</button>
              <button type="button" class="btn color-btn" style="background-color: #fd7e14;" data-category="negative" data-color="#fd7e14">Orange</button>
              <button type="button" class="btn color-btn" style="background-color: #dc3545;" data-category="negative" data-color="#dc3545">Red</button>
              <button type="button" class="btn color-btn" style="background-color: #e83e8c;" data-category="negative" data-color="#e83e8c">Pink</button>
              <button type="button" class="btn color-btn" style="background-color: #6c757d;" data-category="negative" data-color="#6c757d">Gray</button>
              <button type="button" class="btn color-btn" style="background-color: #343a40;" data-category="negative" data-color="#343a40">Dark</button>
            </div>
            <div class="text-center">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="custom-color-negative">
                <i class="fas fa-palette me-1"></i>More Colors
              </button>
              <input type="color" id="color-picker-negative" style="display: none;" data-category="negative">
            </div>
          </div>
        </div>
        <div class="preview-section mt-4">
          <h6>Preview</h6>
          <div class="d-flex gap-3">
            <div class="preview-banner" data-category="positive" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; color: white;">
              <small>Positive Message</small>
            </div>
            <div class="preview-banner" data-category="negative" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; color: white;">
              <small>Negative Message</small>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="apply-colors">Apply Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="deleteModalMessage" class="mb-0">Are you sure you want to delete this message? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Calendar Modal -->
<div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="calendarModalLabel"><i class="fas fa-calendar-alt me-2"></i>Select Date</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <button id="prev-month" class="btn btn-sm btn-outline-secondary">&laquo;</button>
          <span id="current-month-year" class="mx-3 fw-bold"></span>
          <button id="next-month" class="btn btn-sm btn-outline-secondary">&raquo;</button>
        </div>
        <div id="calendar-grid" class="calendar-grid">
          <!-- Calendar will be generated here -->
        </div>
        <div class="mt-3">
          <small class="text-muted">
            <i class="fas fa-circle text-primary me-1"></i>Days with messages
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Avatar Selection Modal -->
<div class="modal fade" id="avatarSelectionModal" tabindex="-1" aria-labelledby="avatarSelectionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="avatarSelectionModalLabel"><i class="fas fa-user-circle me-2"></i>Choose Your Avatar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Select an avatar to personalize your dashboard:</p>
        <div class="row g-3">
          <div class="col-6 col-md-4">
            <div class="text-center">
              <img src="/static/avatars/avatar1.svg" class="avatar-choice rounded-circle mb-2" style="width:80px;height:80px;cursor:pointer;border:3px solid transparent;" data-avatar="avatar1.svg" id="avatar-choice-1">
              <div class="small">Green</div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="text-center">
              <img src="/static/avatars/avatar2.svg" class="avatar-choice rounded-circle mb-2" style="width:80px;height:80px;cursor:pointer;border:3px solid transparent;" data-avatar="avatar2.svg" id="avatar-choice-2">
              <div class="small">Blue</div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="text-center">
              <img src="/static/avatars/avatar3.svg" class="avatar-choice rounded-circle mb-2" style="width:80px;height:80px;cursor:pointer;border:3px solid transparent;" data-avatar="avatar3.svg" id="avatar-choice-3">
              <div class="small">Orange</div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="text-center">
              <img src="/static/avatars/avatar4.svg" class="avatar-choice rounded-circle mb-2" style="width:80px;height:80px;cursor:pointer;border:3px solid transparent;" data-avatar="avatar4.svg" id="avatar-choice-4">
              <div class="small">Purple</div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="text-center">
              <img src="/static/avatars/avatar5.svg" class="avatar-choice rounded-circle mb-2" style="width:80px;height:80px;cursor:pointer;border:3px solid transparent;" data-avatar="avatar5.svg" id="avatar-choice-5">
              <div class="small">Red</div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="text-center">
              <div class="custom-avatar-option rounded-circle mb-2 d-flex align-items-center justify-content-center" style="width:80px;height:80px;cursor:pointer;border:3px solid transparent;background:linear-gradient(45deg,#ff0000,#ff7f00,#ffff00,#00ff00,#0000ff,#4b0082,#9400d3);margin:0 auto;" id="custom-avatar-choice">
                <i class="fas fa-palette text-white" style="font-size:24px;text-shadow:1px 1px 2px rgba(0,0,0,0.7);"></i>
              </div>
              <div class="small">Custom Color</div>
            </div>
          </div>
        </div>
        <!-- Hidden color picker for custom avatar -->
        <input type="color" id="customAvatarColorPicker" style="display: none;" value="#007bff">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="applyAvatarChanges" style="display: none;">
          <i class="fas fa-check me-1"></i>Apply Changes
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}
.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #dee2e6;
  cursor: pointer;
  transition: all 0.2s;
}
.calendar-day:hover {
  background-color: #f8f9fa;
}
.calendar-day.has-messages {
  background-color: var(--primary-color);
  color: white;
}
.calendar-day.has-messages:hover {
  background-color: var(--secondary-color);
}
.calendar-day.other-month {
  color: #6c757d;
  background-color: #f8f9fa;
}
.calendar-header {
  font-weight: bold;
  text-align: center;
  padding: 0.5rem;
  background-color: #f8f9fa;
}
.color-btn {
  color: white;
  margin: 0.25rem;
  border: 2px solid transparent;
  width: 80px;
  font-size: 0.8rem;
}
.color-btn:hover {
  border-color: #333;
  color: white;
}
.color-btn.selected {
  border-color: #000;
  box-shadow: 0 0 0 2px #fff, 0 0 0 4px #000;
}
</style>
{% endblock %}

<button id="theme-toggle-btn" class="theme-toggle-btn" title="Toggle dark mode">
    <i class="fas fa-moon"></i>
</button>

